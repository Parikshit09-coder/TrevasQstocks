pipeline {
  agent {
    docker {
      image 'parikshitdesai388/react-docker-agent:latest'
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
    }
  }
  
  // ‚úÖ Add triggers for auto-run on push
  triggers {
    githubPush()  
  }

  stages {
    
    stage('Checkout Source Code') {
      steps {
        checkout scm
      }
    }

    stage('Install Dependencies') {
      steps {
        sh 'cd Stock && npm ci'
      }
    }

    stage('Build React App') {
      steps {
        sh 'cd Stock && npm run build'
      }
    }

    stage('Static Code Analysis') {
      environment {
        SONAR_URL = "http://54.90.83.180:9000"
      }
      steps {
        withCredentials([string(credentialsId: 'sonarqube', variable: 'SONAR_TOKEN')]) {
          sh '''
            cd Stock
            
            # Run SonarScanner analysis
            docker run --rm \
              -v $(pwd):/usr/src \
              -w /usr/src \
              sonarsource/sonar-scanner-cli:latest \
              -Dsonar.projectKey=react-frontend \
              -Dsonar.projectName="React Frontend" \
              -Dsonar.sources=src \
              -Dsonar.host.url=${SONAR_URL} \
              -Dsonar.login=${SONAR_TOKEN} \
              -Dsonar.exclusions=node_modules/**,dist/**,build/** \
              -Dsonar.javascript.file.suffixes=.js,.jsx,.ts,.tsx \
              -Dsonar.sourceEncoding=UTF-8
          '''
        }
      }
    }

    stage('Build and Push Docker Image') {
      environment {
        DOCKER_IMAGE = "parikshitdesai388/cicd:${BUILD_NUMBER}"
      }
      steps {
        script {
          sh 'cd Stock && docker build -t ${DOCKER_IMAGE} .'
          docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
            docker.image("${DOCKER_IMAGE}").push()
          }
        }
      }
    }

    stage('Update Deployment File in GitOps Repo') {
      environment {
        GIT_REPO_NAME = "react-gitops-manifests"
        GIT_USER_NAME = "Parikshit09-coder"
      }
      steps {
        retry(3) {  // ‚úÖ Retry up to 3 times if git conflict occurs
          withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
            sh '''
              set -e  # Exit on any error
              
              echo "=== Updating GitOps Repository ==="
              
              # ‚úÖ ALWAYS start fresh to avoid conflicts
              rm -rf ${GIT_REPO_NAME} || true
              
              # Clone the GitOps repo
              git clone https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git
              cd ${GIT_REPO_NAME}
              
              # Configure git user
              git config user.email "gurudesai2005@gmail.com"
              git config user.name "Parikshit09-coder"
              
              # Ensure we're on main branch
              git checkout main
              
              # Pull latest changes (in case of concurrent updates)
              git pull origin main --no-rebase
              
              echo "Current image in deployment.yaml:"
              grep "image:" deployment.yaml || echo "Image line not found"
              
              # ‚úÖ Update the image tag in deployment.yaml
              sed -i "s|image: .*|image: parikshitdesai388/cicd:${BUILD_NUMBER}|" deployment.yaml
              
              echo "Updated image in deployment.yaml:"
              grep "image:" deployment.yaml
              
              # Check if there are actual changes
              if git diff --exit-code; then
                echo "No changes to commit. Image tag already at ${BUILD_NUMBER}."
              else
                # Commit the change
                git add deployment.yaml
                git commit -m "Update image to build ${BUILD_NUMBER}"
                
                # ‚úÖ Push to GitHub
                echo "Pushing changes to GitHub..."
                git push origin main
                
                echo "‚úÖ Successfully updated deployment.yaml with image: parikshitdesai388/cicd:${BUILD_NUMBER}"
              fi
            '''
          }
        }
      }
    }
    
    stage('Notify ArgoCD (Optional)') {
      steps {
        script {
          echo "‚úÖ GitOps repository updated successfully!"
          echo "‚úÖ ArgoCD should auto-sync within minutes (if auto-sync enabled)"
          echo "‚úÖ New Docker image: parikshitdesai388/cicd:${BUILD_NUMBER}"
          
          // Optional: Trigger ArgoCD sync via API
          // sh '''
          //   curl -X POST http://argocd-server/api/v1/applications/cicd-pipeline/sync \
          //     -H "Authorization: Bearer ${ARGOCD_TOKEN}" \
          //     -H "Content-Type: application/json" \
          //     --data '{}' || echo "ArgoCD sync trigger failed (maybe auto-sync is enabled)"
          // '''
        }
      }
    }
  }
  
  post {
    success {
      echo "üéâ Pipeline SUCCESS!"
      echo "Build Number: ${BUILD_NUMBER}"
      echo "Image: parikshitdesai388/cicd:${BUILD_NUMBER}"
      echo "GitOps Repo: https://github.com/Parikshit09-coder/react-gitops-manifests"
      echo "ArgoCD App: cicd-pipeline"
    }
    failure {
      echo "‚ùå Pipeline FAILED!"
      echo "Check the logs above for errors."
      echo "Common issues:"
      echo "1. Git conflicts (fixed with retry logic)"
      echo "2. Docker push authentication"
      echo "3. SonarQube connection"
      echo "4. GitHub permissions"
    }
    always {
      echo "Pipeline completed. Cleaning up..."
      // Clean Docker images to save space
      sh 'docker system prune -f --filter "until=24h" || true'
    }
  }
  
  options {
    timeout(time: 30, unit: 'MINUTES')
    buildDiscarder(logRotator(numToKeepStr: '10'))
    disableConcurrentBuilds()  // ‚úÖ Prevent multiple pipelines causing conflicts
  }
}
